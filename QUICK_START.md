# 快速開始：測試難字分析功能

## 1. 確認環境

### 檢查 API Key
```bash
cat .env.local
```
應該看到：
```
GROQ_API_KEY=gsk_...
```

### 啟動開發服務器（如未運行）
```bash
npm run dev
```

等待看到：
```
✓ Ready in 2s
○ Local: http://localhost:3000
```

## 2. 測試流程

### 步驟 1：打開主頁
1. 瀏覽器訪問：http://localhost:3000
2. 點擊 "播放器模式" 進入 `/player`

### 步驟 2：輸入測試視頻
在播放器頁面輸入任意 YouTube 視頻 ID，例如：
- `dQw4w9WgXcQ` (短視頻)
- 或任何其他有英文字幕的視頻

### 步驟 3：打開字幕頁面
1. 新標籤頁訪問：http://localhost:3000/subtitle
2. **重要**：打開瀏覽器開發者工具（F12）並切換到 Console 標籤

### 步驟 4：開始播放視頻
在播放器頁面點擊播放按鈕

### 步驟 5：觀察調試輸出

#### 在字幕頁面的控制台，你應該看到：

```
[前端] 沒有快取資料
[前端] 字幕切換: -1 -> 0
[前端] 開始分析字幕 0: Hello, this is...
[API] 收到分析請求: { videoId: 'xxx', subtitleIndex: 0, text: '...' }
[API] 準備呼叫 Groq API...
[API] Groq API 回應狀態: 200
[API] Groq API 原始回應: [{"word":"...","translation":"..."}]
[API] 解析成功，難字數量: 2 [...]
[前端] API 回應: { success: true, vocabulary: [...] }
[前端] 字幕 0 分析完成，難字數: 2 [...]
[前端] 當前字幕 0 難字: [...]
```

#### 在字幕頁面，你應該看到：

**右上角調試面板：**
```
VideoID: dQw4w9WgXcQ
字幕數: 45
當前索引: 0
快取條目: 1
當前難字: 2
正在分析: 否
```

**左上角難字顯示區（如果有難字）：**
```
字幕 #0 的難字：
sophisticated : 複雜的
demonstrate : 展示
```

### 步驟 6：測試快取機制
1. 繼續播放視頻，等待幾句字幕
2. 控制台應該顯示新字幕的分析
3. 返回第一句字幕（拖動進度條）
4. 控制台應該顯示：
   ```
   [前端] 字幕 0 已有快取，難字數: 2
   ```
5. **不應該**再次呼叫 API

### 步驟 7：測試持久化
1. 刷新字幕頁面（F5）
2. 控制台應該顯示：
   ```
   [前端] 已載入快取的詞彙分析，條目數: 5
   ```
3. 播放到已分析過的字幕，應該立即顯示難字（無需等待 API）

## 3. 常見問題排查

### Q: 沒有看到難字顯示
**檢查清單：**
- [ ] 控制台是否有 `[前端] 字幕切換` 輸出？
- [ ] 控制台是否有 `[API] 收到分析請求` 輸出？
- [ ] 調試面板的 "當前索引" 是否 >= 0？
- [ ] 調試面板的 "當前難字" 是否 > 0？
- [ ] 字幕是否包含英文（難字分析只支持英文）？
- [ ] 字幕長度是否 >= 10 字符？

### Q: 控制台出現 API 錯誤
**可能原因：**
1. **API Key 錯誤**
   ```
   [API] Groq API 錯誤: 401
   ```
   解決：檢查 `.env.local` 中的 API Key

2. **網絡問題**
   ```
   [前端] 分析請求失敗: Failed to fetch
   ```
   解決：檢查網絡連接

3. **API 額度用完**
   ```
   [API] Groq API 錯誤: 429
   ```
   解決：等待額度重置（Groq 免費版：30次/分鐘）

### Q: 字幕頁面沒有更新時間
**原因：** 字幕頁面需要從播放器頁面接收時間更新

**解決：**
1. 確保播放器頁面和字幕頁面同時打開
2. 確保兩個頁面在同一瀏覽器（BroadcastChannel 限制）
3. 播放器頁面必須正在播放

### Q: 調試面板顯示 "當前索引: -1"
**原因：** 當前時間不在任何字幕的時間範圍內

**正常情況：**
- 視頻開始前：索引 = -1
- 字幕之間的間隙：索引 = -1
- 字幕播放時：索引 >= 0

## 4. 性能測試

### 測試場景 1：首次播放
1. 清除 localStorage（瀏覽器開發者工具 > Application > Local Storage > 刪除所有）
2. 重新載入視頻
3. 播放前 10 句字幕
4. 觀察：
   - 每句字幕切換時會有 ~1-2 秒延遲（API 請求）
   - 調試面板的 "快取條目" 應該從 0 逐漸增加到 10
   - 每句只請求 1 次 API

### 測試場景 2：重複播放
1. 返回第一句字幕
2. 觀察：
   - 難字應該立即顯示（無延遲）
   - 控制台顯示 "已有快取"
   - 不應該有新的 API 請求

### 測試場景 3：跳過播放
1. 從第 1 句跳到第 20 句
2. 觀察：
   - 只分析第 20 句（不分析中間的 2-19 句）
   - API 請求數 = 實際觀看的字幕數

## 5. 調試技巧

### 查看完整的快取數據
在瀏覽器控制台執行：
```javascript
const videoId = 'dQw4w9WgXcQ'; // 替換為你的視頻 ID
const cache = localStorage.getItem(`dubtitle_vocab_${videoId}`);
console.log(JSON.parse(cache));
```

### 清除特定視頻的快取
```javascript
const videoId = 'dQw4w9WgXcQ';
localStorage.removeItem(`dubtitle_vocab_${videoId}`);
console.log('快取已清除');
```

### 查看所有快取
```javascript
Object.keys(localStorage)
  .filter(key => key.startsWith('dubtitle_vocab_'))
  .forEach(key => {
    const data = JSON.parse(localStorage.getItem(key));
    console.log(key, '條目數:', Object.keys(data).length);
  });
```

## 6. 成功指標

✅ **功能正常的標誌：**
- 控制台有完整的調試輸出
- 調試面板數據實時更新
- 難字在分析完成後顯示
- 第二次播放同一句字幕時無延遲
- 刷新頁面後快取仍然存在

## 7. 下一步

如果一切正常，可以：
1. 移除或隱藏調試面板（生產環境）
2. 優化 UI 樣式
3. 添加錯誤提示
4. 實現預加載（提前分析接下來的 2-3 句）
5. 添加導出/導入快取功能

## 需要幫助？

查看詳細文檔：`VOCABULARY_FIX_SUMMARY.md`
